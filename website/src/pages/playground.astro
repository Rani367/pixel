       onAbort: (what: string) => {
          logToConsole(`Aborted: ${what}`, 'text-red-400');
          isRunning = false;
        },

        locateFile: (path: string) => {
          const base = import.meta.env.BASE_URL.endsWith('/')
            ? import.meta.env.BASE_URL
            : import.meta.env.BASE_URL + '/';
          return base + 'wasm/' + path;
        }
      };

      script.onerror = () => reject(new Error('Failed to load WASM module'));
      document.body.appendChild(script);
    });
  }

  // Run Pixel code
  async function runPixelCode(code: string) {
    if (isRunning) {
      logToConsole('Stopping previous execution...', 'text-yellow-400');
      // Cancel Emscripten main loop if running
      if (pixelModule && pixelModule._emscripten_cancel_main_loop) {
        pixelModule._emscripten_cancel_main_loop();
      }
      // Small delay to let cleanup happen
      await new Promise(r => setTimeout(r, 100));
    }

    clearConsole();
    logToConsole('Running...', 'text-cyan-400');

    try {
      const module = await loadPixelModule();

      // Write code to virtual filesystem
      const encoder = new TextEncoder();
      const codeBytes = encoder.encode(code);
      // FS is a global in Emscripten
      const FS = (window as any).FS || module.FS;
      FS.writeFile('/game.pixel', codeBytes);

      isRunning = true;

      // Call main with arguments: pixel run /game.pixel
      // Use global Module since that's where Emscripten puts callMain
      const Module = (window as any).Module;
      try {
        if (Module.callMain) {
          Module.callMain(['run', '/game.pixel']);
        } else {
          logToConsole('callMain not available', 'text-yellow-400');
        }
      } catch (runErr: any) {
        logToConsole(`Runtime error: ${runErr.message}`, 'text-red-400');
        isRunning = false;
      }

    } catch (err: any) {
      logToConsole(`Error: ${err.message}`, 'text-red-400');
      isRunning = false;
    }
  }

  // Run button
  const runBtn = document.getElementById('run-btn');
  runBtn?.addEventListener('click', () => {
    const code = editor?.state.doc.toString() || '';
    runPixelCode(code);
  });

  // Pre-load the WASM module
  loadPixelModule().catch(err => {
    logToConsole(`Failed to load runtime: ${err.message}`, 'text-red-400');
  });
</script>

<style>
  #editor :global(.cm-editor) {
    height: 100%;
  }
  #editor :global(.cm-scroller) {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  #editor :global(.cm-scroller)::-webkit-scrollbar {
    display: none;
  }
</style>
