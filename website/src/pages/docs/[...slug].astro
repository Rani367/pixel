---
import BaseLayout from '../../layouts/BaseLayout.astro';
import fs from 'node:fs';
import path from 'node:path';

export function getStaticPaths() {
  return [
    { params: { slug: 'getting-started' } },
    { params: { slug: 'installation' } },
    { params: { slug: 'language/basics' } },
    { params: { slug: 'language/control-flow' } },
    { params: { slug: 'language/functions' } },
    { params: { slug: 'language/data-structures' } },
    { params: { slug: 'language/index' } },
    { params: { slug: 'api/core' } },
    { params: { slug: 'api/math' } },
    { params: { slug: 'api/engine' } },
    { params: { slug: 'api/input' } },
    { params: { slug: 'api/audio' } },
    { params: { slug: 'api/physics' } },
  ];
}

const { slug } = Astro.params;

// Parse YAML frontmatter
function parseFrontmatter(content: string): { frontmatter: Record<string, string | string[]>; body: string } {
  const frontmatterRegex = /^---\n([\s\S]*?)\n---\n/;
  const match = content.match(frontmatterRegex);

  if (!match) {
    return { frontmatter: {}, body: content };
  }

  const frontmatter: Record<string, string | string[]> = {};
  const yamlLines = match[1].split('\n');

  for (const line of yamlLines) {
    const colonIndex = line.indexOf(':');
    if (colonIndex > 0) {
      const key = line.slice(0, colonIndex).trim();
      let value = line.slice(colonIndex + 1).trim();
      // Remove quotes if present
      if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith("'") && value.endsWith("'"))) {
        value = value.slice(1, -1);
      }
      // Handle arrays (simple case)
      if (value.startsWith('[') && value.endsWith(']')) {
        frontmatter[key] = value.slice(1, -1).split(',').map(s => s.trim().replace(/['"]/g, ''));
      } else {
        frontmatter[key] = value;
      }
    }
  }

  return { frontmatter, body: content.slice(match[0].length) };
}

// Read the markdown file
const docsPath = path.join(process.cwd(), '..', 'docs', `${slug}.md`);
let content = '';
let title = slug?.split('/').pop() || 'Documentation';
let description = '';
let keywords: string[] = [];

try {
  const rawContent = fs.readFileSync(docsPath, 'utf-8');
  const { frontmatter, body } = parseFrontmatter(rawContent);

  content = body;

  // Use frontmatter values if available
  if (frontmatter.title) {
    title = frontmatter.title as string;
  } else {
    // Extract title from first heading
    const titleMatch = content.match(/^#\s+(.+)$/m);
    if (titleMatch) {
      title = titleMatch[1];
    }
  }

  if (frontmatter.description) {
    description = frontmatter.description as string;
  }

  if (frontmatter.keywords && Array.isArray(frontmatter.keywords)) {
    keywords = frontmatter.keywords;
  }
} catch (e) {
  content = `# Not Found\n\nThe page "${slug}" was not found.`;
}

// Simple markdown to HTML
function parseMarkdown(md: string): string {
  // First, handle tables
  let result = md.replace(/\n\|(.+)\|\n\|[-\s|]+\|\n((?:\|.+\|\n?)+)/g, (match, header, body) => {
    const headers = header.split('|').map((h: string) => h.trim()).filter((h: string) => h);
    const rows = body.trim().split('\n').map((row: string) => {
      return row.split('|').map((cell: string) => cell.trim()).filter((cell: string) => cell !== '');
    });

    let table = '<div class="overflow-x-auto my-4"><table class="w-full text-sm border-collapse">';
    table += '<thead><tr class="border-b border-zinc-300 dark:border-zinc-700">';
    headers.forEach((h: string) => {
      table += `<th class="text-left py-2 px-3 font-semibold">${h}</th>`;
    });
    table += '</tr></thead><tbody>';
    rows.forEach((row: string[]) => {
      table += '<tr class="border-b border-zinc-200 dark:border-zinc-800">';
      row.forEach((cell: string) => {
        table += `<td class="py-2 px-3">${cell}</td>`;
      });
      table += '</tr>';
    });
    table += '</tbody></table></div>';
    return table;
  });

  return result
    // Code blocks (must be before other replacements)
    .replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
      return `<pre class="bg-zinc-900 text-zinc-100 p-4 rounded-lg overflow-x-auto my-4 text-sm"><code>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`;
    })
    // Headers
    .replace(/^#### (.*$)/gim, '<h4 class="text-base font-semibold mt-5 mb-2">$1</h4>')
    .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-6 mb-2">$1</h3>')
    .replace(/^## (.*$)/gim, '<h2 class="text-xl font-semibold mt-8 mb-3 pb-2 border-b border-zinc-200 dark:border-zinc-800">$1</h2>')
    .replace(/^# (.*$)/gim, '<h1 class="text-3xl font-bold mb-6">$1</h1>')
    // Bold and italic
    .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    // Inline code
    .replace(/`([^`]+)`/g, '<code class="bg-zinc-100 dark:bg-zinc-800 px-1.5 py-0.5 rounded text-sm font-mono">$1</code>')
    // Links
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-[--color-accent] hover:underline">$1</a>')
    // Unordered lists
    .replace(/^\- (.*$)/gim, '<li class="ml-4 list-disc">$1</li>')
    // Numbered lists
    .replace(/^\d+\. (.*$)/gim, '<li class="ml-4 list-decimal">$1</li>')
    // Horizontal rule
    .replace(/^---$/gim, '<hr class="my-8 border-zinc-200 dark:border-zinc-800">')
    // Paragraphs (simple approach)
    .split('\n\n')
    .map(p => {
      const trimmed = p.trim();
      if (!trimmed) return '';
      if (trimmed.startsWith('<')) return trimmed;
      if (trimmed.startsWith('-') || trimmed.match(/^\d+\./)) return `<ul class="my-4 space-y-1">${trimmed}</ul>`;
      return `<p class="mb-4 leading-relaxed">${trimmed}</p>`;
    })
    .join('\n');
}

const html = parseMarkdown(content);

const sidebar = [
  { title: 'Getting Started', href: '/pixel/docs/getting-started' },
  { title: 'Installation', href: '/pixel/docs/installation' },
  {
    title: 'Language',
    items: [
      { title: 'Basics', href: '/pixel/docs/language/basics' },
      { title: 'Control Flow', href: '/pixel/docs/language/control-flow' },
      { title: 'Functions', href: '/pixel/docs/language/functions' },
      { title: 'Data Structures', href: '/pixel/docs/language/data-structures' },
    ]
  },
  {
    title: 'API Reference',
    items: [
      { title: 'Core', href: '/pixel/docs/api/core' },
      { title: 'Math', href: '/pixel/docs/api/math' },
      { title: 'Engine', href: '/pixel/docs/api/engine' },
      { title: 'Input', href: '/pixel/docs/api/input' },
      { title: 'Audio', href: '/pixel/docs/api/audio' },
      { title: 'Physics', href: '/pixel/docs/api/physics' },
    ]
  },
];

// Determine active page
const currentPath = `/pixel/docs/${slug}`;
---

<BaseLayout title={title} description={description} keywords={keywords} type="article">
  <div class="max-w-6xl mx-auto px-4 py-12">
    <!-- Mobile sidebar toggle -->
    <button
      id="sidebar-toggle"
      class="md:hidden mb-4 px-4 py-2 bg-zinc-100 dark:bg-zinc-800 rounded-lg text-sm font-medium flex items-center gap-2"
      aria-expanded="false"
      aria-controls="sidebar"
      aria-label="Toggle navigation menu"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
      Menu
    </button>

    <div class="flex gap-12">
      <!-- Sidebar -->
      <aside id="sidebar" class="w-64 shrink-0 hidden md:block">
        <nav class="sticky top-24 space-y-6">
          {sidebar.map(section => (
            <div>
              {section.items ? (
                <>
                  <h4 class="font-semibold text-sm text-zinc-900 dark:text-zinc-100 mb-2">{section.title}</h4>
                  <ul class="space-y-1">
                    {section.items.map(item => (
                      <li>
                        <a
                          href={item.href}
                          class:list={[
                            "block text-sm py-1 transition-colors",
                            currentPath === item.href
                              ? "text-[--color-accent] font-medium"
                              : "text-zinc-600 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100"
                          ]}
                        >
                          {item.title}
                        </a>
                      </li>
                    ))}
                  </ul>
                </>
              ) : (
                <a
                  href={section.href}
                  class:list={[
                    "block text-sm font-medium transition-colors",
                    currentPath === section.href
                      ? "text-[--color-accent]"
                      : "text-zinc-600 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100"
                  ]}
                >
                  {section.title}
                </a>
              )}
            </div>
          ))}
        </nav>
      </aside>

      <!-- Content -->
      <article class="flex-1 min-w-0">
        <Fragment set:html={html} />
      </article>
    </div>
  </div>

  <script>
    const toggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('sidebar');

    toggle?.addEventListener('click', () => {
      const isExpanded = sidebar?.classList.toggle('hidden') === false;
      sidebar?.classList.toggle('block');
      toggle?.setAttribute('aria-expanded', isExpanded.toString());
    });
  </script>
</BaseLayout>
