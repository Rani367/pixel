name: CI
on:
  workflow_dispatch:
  push:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'benchmarks/**'
      - 'CMakeLists.txt'
      - '.github/workflows/ci.yml'
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'benchmarks/**'
      - 'CMakeLists.txt'
      - '.github/workflows/ci.yml'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: [Debug, Release]

    steps:
      - uses: actions/checkout@v4

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

      - name: Build
        run: cmake --build build

      - name: Test
        run: cd build && ctest --output-on-failure

      - name: Verify CLI
        run: ./build/pixel version

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install lcov and llvm
        run: sudo apt-get update && sudo apt-get install -y lcov llvm clang

      - name: Configure with coverage
        run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON -DCMAKE_C_COMPILER=clang

      - name: Create llvm-cov wrapper
        run: |
          echo '#!/bin/bash' | sudo tee /usr/local/bin/llvm-gcov
          echo 'exec llvm-cov gcov "$@"' | sudo tee -a /usr/local/bin/llvm-gcov
          sudo chmod +x /usr/local/bin/llvm-gcov

      - name: Build
        run: cmake --build build

      - name: Run tests with coverage
        run: |
          cd build
          lcov --zerocounters --directory . --ignore-errors unused,unsupported
          ctest --output-on-failure
          lcov --capture --directory . --output-file coverage_raw.info \
               --gcov-tool /usr/local/bin/llvm-gcov \
               --ignore-errors unused,unsupported,gcov
          lcov --extract coverage_raw.info '*/src/*' --output-file coverage.info \
               --ignore-errors unused,unsupported
          genhtml coverage.info --output-directory coverage_report \
               --ignore-errors unused,unsupported
          lcov --summary coverage.info --ignore-errors unused,unsupported

      - name: Check coverage threshold
        id: coverage
        run: |
          cd build
          COVERAGE=$(lcov --summary coverage.info 2>&1 | grep "lines" | sed 's/.*: *\([0-9.]*\)%.*/\1/')
          echo "Line coverage: $COVERAGE%"
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          if [ $(echo "$COVERAGE < 100" | bc -l) -eq 1 ]; then
            echo "ERROR: Coverage is $COVERAGE%, but 100% is required"
            echo "New code must have tests, or use LCOV_EXCL markers for untestable code"
            exit 1
          fi

      - name: Update coverage badge
        if: github.ref == 'refs/heads/main'
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ secrets.COVERAGE_GIST_ID }}
          filename: coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.coverage }}%
          valColorRange: ${{ steps.coverage.outputs.coverage }}
          maxColorRange: 100
          minColorRange: 0

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/coverage_report
        if: always()

  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-tidy
        run: sudo apt-get update && sudo apt-get install -y clang-tidy

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy
        run: |
          find src -name '*.c' | head -20 | xargs clang-tidy -p build \
            --checks='-*,clang-analyzer-*,bugprone-*' || true
        # Run on subset of files and don't fail build for now

  format-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format

      - name: Check formatting
        run: |
          # Check formatting but don't fail build for now
          find src tests -name '*.c' -o -name '*.h' | head -20 | xargs clang-format --dry-run || true

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact: pixel-linux-x64
            binary: pixel
          - os: macos-latest
            artifact: pixel-macos-x64
            binary: pixel
          - os: macos-14
            artifact: pixel-macos-arm64
            binary: pixel
          - os: windows-latest
            artifact: pixel-windows-x64
            binary: pixel.exe

    steps:
      - uses: actions/checkout@v4

      - name: Install SDL2 (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev libsdl2-mixer-dev

      - name: Install SDL2 (macOS)
        if: startsWith(matrix.os, 'macos')
        run: brew install sdl2 sdl2_image sdl2_ttf sdl2_mixer

      - name: Install SDL2 (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          vcpkg install sdl2:x64-windows sdl2-image:x64-windows sdl2-ttf:x64-windows sdl2-mixer:x64-windows
        shell: bash

      - name: Configure (Unix)
        if: matrix.os != 'windows-latest'
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Configure (Windows)
        if: matrix.os == 'windows-latest'
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake

      - name: Build
        run: cmake --build build --config Release

      - name: Create artifact directory
        run: mkdir -p dist
        shell: bash

      - name: Copy binary (Unix)
        if: matrix.os != 'windows-latest'
        run: cp build/${{ matrix.binary }} dist/

      - name: Copy binary (Windows)
        if: matrix.os == 'windows-latest'
        run: cp build/Release/${{ matrix.binary }} dist/
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.binary }}

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/${{ matrix.binary }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
